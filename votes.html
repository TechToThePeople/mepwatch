<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta content="initial-scale=1, shrink-to-fit=no, width=device-width" name="viewport">

    <!-- CSS -->
    <link href="dist/css/main.css" rel="stylesheet">

<style>
td a {color:rgb(33, 150, 243);}

    .icon
    {
      display: inline-block;
      width: 25px;
      height: 20px;
      text-indent: 100%;
      white-space: nowrap;
      overflow: hidden;
      background-size: cover;
      background-position:center;
    }

.navbar-brand svg {
  width:2em;
  fill:white;
  animation: pulse 3s 9s;
}

@keyframes pulse {
  0% {
    fill: #9c27b0;
  }
  50% {
    fill: white;
  }
  100% {
    fill: #9c27b0;
  }
}
  .heatmap g.axis text {transform: translateX(0.7em)}
  tr.dc-table-row {
    cursor:pointer;
  }
  tr.dc-table-row:hover {
    transition: background-color 1s; 
    transition: color 1s; 
    background-color:#9c27b0;
    color:white;
  }

</style>
  </head>
  <body>
    <header>
      <div class="collapse bg-primary-light" id="navbarHeader">
        <div class="container">
          <div class="row">
            <div class="col-sm-8 col-md-7 py-4">
              <h4 class="">About</h4>
              <p class="">
              </p>
            </div>
            <div class="col-sm-4 offset-md-1 py-4">
              <h4 class="">Contact</h4>
              <ul class="list-unstyled">
                <li><a href="https://twitter.com/eucampaign" class="">Follow on Twitter</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="navbar navbar-dark bg-primary box-shadow">
        <div class="container d-flex justify-content-between">
          <a href="#" class="navbar-brand d-flex align-items-center">
            <svg><use href="#logo" /></svg>MEP Watch
            
          </a>

          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarHeader" aria-controls="navbarHeader" aria-expanded="false" aria-label="Toggle navigation">
            <svg class="icon"><use href="#menu" /></svg>

          </button>
        </div>
      </div>
    </header>

    <main role="main">

      <section class="jumbotron text-center">
        <div class="container">
          <h3 class="jumbotron-heading">Select the votes you want to analyse</h3>
        </div>
      </section>
     <div class="bg-info">
        <div class="container-fluid">

          <div class="d-flex flex-row md-3 justify-content-between align-items-center" id="summary">
            <div class="p-2">
              <form id="search"></form>
            </div>
            <div class="p-2 nbrollcalls">
              <span class="nb"></span> rollcalls
            </div>
            <div class="p-2 nbvotes">
              <span class="nb"></span>  MEPs votes
            </div>
          </div>
        </div>
     </div>
     <div class="py-5 gradient">
        <div class="container-fluid">

          <div class="row">
            <div class="col-md-12">
              <div class="card box-shadow" id="date">
                <div class="card-body">
                  <h5 class="card-title text-muted text-right"><span class="nb"></span> Plenary days</h5>
                  <p class="card-text d-none">
                  All the plenary sessions with at least one rollcall</p>
                  <div class="graph"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

          <div class="row">
            <div class="col-md-12">
            <table class="table table-stripped">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Ref</th>
                  <th>Vote</th>
                  <th title="for"><svg class="icon"><use href="#icon-for"/></svg></th>
                  <th title="against"><svg class="icon"><use href="#icon-against"/></svg></th>
                  <th title="abstention"><svg class="icon"><use href="#icon-abstention"/></svg></th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
            </div>
          </div>
    </main>

    <footer class="text-muted">
      <div class="container">
        <p class="float-right">
          <a href="#">Back to top</a>
        </p>
      </div>
    </footer>

    <!-- Optional JavaScript -->
    <script src="dist/js/main.js"></script> 
    <script src="dist/js/dcbundle.js"></script>
    <script src="src/js/vote.js"></script>
<script>
  'use strict';
  var ndx=null;
  var graphs={};
  var q=d3.queue();
  var docs = {};
  docs.get=function(reference){
    docs[reference] ? docs[reference] : "";
  };

  var dateParse = d3.timeParse("%Y-%m-%d");
  var dateTimeParse = d3.timeParse("%Y-%m-%dT%H:%M:%S");
  var dayFormat = d3.timeFormat("%Y-%m-%d");
  var dateFormat = d3.timeFormat("%Y-%m-%d %H:%M:%S");
  var week = d3.timeFormat("%V");
  //d3.csv('data/ep_votes.csv',function(d){
  q
  .defer(dl_votes)
  .defer(dl_doc)
  .awaitAll(function(error,results){
    draw();
  });

  function dl_doc (callback){
    d3.csv('data/text_tabled.csv',function(d){
      docs[d.reference]=d;
    }).then(function(d){
      callback();
    });
  };

  function dl_votes (callback){
    d3.csv('data/item_rollcall.csv',function(d){
      d.date=dateParse(d.date.substring(0,10));
      if (!d.date) {console.log(d)}
      
      d.day=d.date.getDay();
      d.week=+week(d.date);
      d.year=d.date.getYear();
      ["for","against","abstention","identifier"].forEach(function(i) {
        d[i]= +d[i] || "";
      });
      return d;
    })
    .then(function(d){
      ndx = crossfilter(d);
//      draw();
      callback();
    });
  };

  function draw(){
    graphs.date=drawDate('#date div.graph');
//    graphs.report=drawReport('#report div.graph');
    graphs.table=drawTable('table.table');
    graphs.search=drawSearch("form#search");

    drawNumbers(graphs);

    dc.renderAll();
  }

  function drawNumbers(graphs) {
    var dim = ndx.dimension(function(d) {
      return true;
    });

    var reducer = reductio();
    reducer.count(true);
    results.forEach(function(r){
      reducer.value(r).count(true).sum(function(d){ return +d[r]});
    });

    var group = dim.group();
    reducer(group);


    graphs.rollcalls = dc.numberDisplay(".nbrollcalls .nb")
      .group(group)
      .valueAccessor(function(d) {return d.value.count})
      .formatNumber(d3.format("d"))
      .on("renderlet.linked",function(){
        return;
        var d=group.top(1)[0].value.nb.count;
        d3.select(".nbmep button").classed("disabled",d == config.nb);
        d3.select(".nbmep .total").classed("d-none",d == config.nb);
      });

    graphs.rollcalls = dc.numberDisplay(".nbvotes .nb")
      .group(group)
      .valueAccessor(function(d) {return +d.value.for.sum + +d.value.against.sum + +d.value.abstention.sum})
      .formatNumber(d3.format("d"));

    d3.select(".resetall").on("click",function(){
      dc.filterAll();
      dc.renderAll();
    });

  };

  function drawReport(dom){

    var tip = d3.tip()
      .attr('class', 'd3-tip')
      .offset([0, 10])
      .direction("e")
      .html(function(d) {
        console.log(docs[d.key]);
        return docs[d.key]? "<h3>"+docs[d.key].rapporteur+"</h3>"+docs[d.key].title +":"+ d.value: d.value;
//        return abbr(d.key) + "<br><b>" + d.value + " MEPs</b>&nbsp;<i>" + formatPercent(d.value/summary.total) +"</i>";
      });

    //var dim = ndx.dimension(function(d) {return d.report?d.report:"?";}, true);
    var dim = ndx.dimension(function(d) {return d.report? d.report : "?";});
    var group = dim.group().reduceSum(function(d) {
      return 1;
    });

    var graph = dc.rowChart(dom)
      .width(0)
      .height(300)
      //      .rowsCap(18)
//      .ordering(function(d) {  return -d.key      })
      .cap(10)
      .label (function(d){return docs[d.key]? docs[d.key].rapporteur : d.key})
      .renderTitle(false)
      .margins({
        top: 0,
        right: 0,
        bottom: 20,
        left: 0
      })
//      .ordinalColors([committee_color])
      .gap(0)
      .elasticX(true)
      .dimension(dim)
      .group(group)
      .on("renderlet.top", function(c) {
          c.selectAll("g.row")
            .call(tip)
            .on("mouseover.tip", tip.show)
            .on("mouseout.tip", tip.hide);
      });
    graph.xAxis().ticks(3);

    return graph;
  }

  function drawDate(dom){ // not working for now....
    //var dim=ndx.dimension(function(d){return [d.year,d.week,d.day]});
    var col=d3.timeFormat("%y-%m-%w");
    var coltick=d3.timeFormat("%b");
    var lasttick="";
    var dim=ndx.dimension(function(d){return d.date});
    var group=dim.group().reduceSum(function(d){return 1});
//    var day=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    var day=["Sat","Fri","Thu","Wed","Tue","Mon","Sun"];
    var color = d3.scaleLinear()
            .domain([0,1, 300])
            .range(["white","lightgrey","#7b2253"]);
    var tip = d3.tip()
    .attr('class', 'd3-tip wide-tip')
    .offset([-10, 0])
    .html(function (d) {
      return "<h5>"+dayFormat(d.key)+"</h5><div>Rollcalls"
        + "<span class='p-2 badge badge-primary ml-2'>"
        +d.value 
        + "</span></div>";
    });
    var graph=dc.heatMap(dom)
     .dimension(dim)
     .group(group)
     .width(0)
     .height(150)
      .rowsLabel(function(d){
        return day[d];
      })
      .colsLabel(function(d){
        var t=Math.floor(d /100000);
        if(lasttick !==t){
          lasttick=t;
          return t;
        }
        return "";
     })
//     .title(function(d){return dayFormat(d.key)+ " "+d.value+ " rollcalls"})
//     .label(function(d){return dayFormat(d.key) + " "+d.value+ " rollcalls"})
     .keyAccessor(function(d) { 
       return 1000*d.key.getFullYear()+week(d.key);
     })
     .valueAccessor(function(d) { return 6-d.key.getDay(); })
     .colorAccessor(function(d) { return +d.value; })
     .colors(color)
    
    graph.on('pretransition', function(chart) {
      graph.selectAll('.heat-box')
      .call(tip)
      .on('mouseover.tip', tip.show)
      .on('mouseout.tip', tip.hide);
    });

    d3.select("#date .nb").html(graph.data().length);

    return graph;
  }

  function drawSearch(dom){

    var dim=ndx.dimension(function(d) {
      //var t= docs[d.report] && docs[d.report].name ? docs[d.report].name.toLowerCase() : "";
      var t= docs[d.report] && docs[d.report].title ? docs[d.report].title.toLowerCase() : "";
      return t + d.report.toLowerCase()+" "+ d.desc.toLowerCase()+" "+d.for + " " + d.against;
    });
    var filter = function (query) {
//        query = _normalize(query);
        return function (d) {
            return d.indexOf(query.toLowerCase()) !== -1;
        };
    };

    var q=urlParam("q");

    var chart=dc.textFilterWidget(dom)
      .placeHolder("search by name")
      .filterFunctionFactory(filter)
      .on("filtered",function(){
        console.log("filter");
      })
      .on("renderlet.urlparam",function(){
        d3.select(dom + " input").classed("form-control",true);
        var input=d3.select(this.anchor() +" input");
        if (input.property("value")) {
          if (q != input.property("value")) {
            urlParam("q",input.property("value"));
          }
          return; // nothing else to do, already set
        }
        if (q) {
          input.property("value",q).dispatch("input");
          q = null;
        }
      })
      .dimension(dim);
    return chart;
  }

  function drawTable(dom){
    var dim = ndx.dimension(function(d) {
      return d.identifier
    });
    var graph = dc.dataTable(dom)
      .dimension(dim)
      .size(100)
      .sortBy(function(d) {
        return d.date;
      })
      .order (d3.descending)
      .showGroups(false)
      .group(function(d) {
        return null;
      })
      .columns([
        function(d) {
          return "<span title='"+d.identifier+"'>" +dayFormat(d.date) +"</span>";
        }
        ,function(d){ 
          if (docs[d.report])
            return "<div class='rapporteur'>" +docs[d.report].rapporteur +"</div>&nbsp;<a href='http:/www.europarl.europa.eu"+ docs[d.report].oeil+"'>"+ d.report +"</a>";
          return d.report;
        }
        ,function(d){ 
          return docs[d.report]? "<a href='http:/www.europarl.europa.eu"+docs[d.report].oeil+"'>"+docs[d.report].title +"</a>&nbsp;"+d.desc : d.desc;}
        ,function(d){ return d.for > d.against ? "<b>"+d.for+"</b>":d.for;}
        ,function(d){ return d.against > d.for ? "<b>"+d.against+"</b>":d.against;}
        ,function(d){ return d.abstention;}
    ])
    .on("renderlet.govote", function(g) {
      g.selectAll("tr.dc-table-row")
        .on("click", function(d) {
          window.open("vote.html?v="+d3.select(this).datum().identifier);
          console.log(d3.select(this).datum());
        });
    });
    return graph;
  }

var urlParam = function (name,value) {
  if (value) {
    var uri=window.location.href;
    var re = new RegExp("([?&])" + name + "=.*?(&|#|$)", "i");
    if (uri.match(re)) {
    uri=uri.replace(re, '$1' + name + "=" + value + '$2');
    } else {
      var hash =  '';
      if( uri.indexOf('#') !== -1 ){
        hash = uri.replace(/.*#/, '#');
        uri = uri.replace(/#.*/, '');
      }
      var separator = uri.indexOf('?') !== -1 ? "&" : "?";
      uri= uri + separator + name + "=" + value + hash;
    }
    history.pushState({q:value},"search for "+value,uri);
    return uri;
  } else {
    var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
    if (results == null) {
      return null;
    } else {
      return decodeURI(results[1]) || 0;
    }
  }
};


</script>

<svg class="d-none">
  <symbol id="menu" viewBox="0 0 24 24">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
</symbol>
  <symbol id="icon-against" viewBox="0 0 24 24">
    <path fill="#c0392b" d="M19,15H23V3H19M15,3H6C5.17,3 4.46,3.5 4.16,4.22L1.14,11.27C1.05,11.5 1,11.74 1,12V14A2,2 0 0,0 3,16H9.31L8.36,20.57C8.34,20.67 8.33,20.77 8.33,20.88C8.33,21.3 8.5,21.67 8.77,21.94L9.83,23L16.41,16.41C16.78,16.05 17,15.55 17,15V5C17,3.89 16.1,3 15,3Z" />
  </symbol>
  <symbol id="icon-for" viewBox="0 0 24 24">
    <path fill="#27ae60" d="M23,10C23,8.89 22.1,8 21,8H14.68L15.64,3.43C15.66,3.33 15.67,3.22 15.67,3.11C15.67,2.7 15.5,2.32 15.23,2.05L14.17,1L7.59,7.58C7.22,7.95 7,8.45 7,9V19A2,2 0 0,0 9,21H18C18.83,21 19.54,20.5 19.84,19.78L22.86,12.73C22.95,12.5 23,12.26 23,12V10M1,21H5V9H1V21Z" />
  </symbol>
  <symbol id="icon-abstention" viewBox="0 0 24 24">
    <path transform="rotate(240 12 12)" fill="#2980b9" d="M23,10C23,8.89 22.1,8 21,8H14.68L15.64,3.43C15.66,3.33 15.67,3.22 15.67,3.11C15.67,2.7 15.5,2.32 15.23,2.05L14.17,1L7.59,7.58C7.22,7.95 7,8.45 7,9V19A2,2 0 0,0 9,21H18C18.83,21 19.54,20.5 19.84,19.78L22.86,12.73C22.95,12.5 23,12.26 23,12V10M1,21H5V9H1V21Z" />
  </symbol>
<symbol id="logo" viewBox="0 0 24 24"><path d="M6 13c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0 4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0-8c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm-3 .5c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zM6 5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm15 5.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5-.5.22-.5.5.22.5.5.5zM14 7c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1zm0-3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5-.5.22-.5.5.22.5.5.5zm-11 10c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zm7 7c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zm0-17c.28 0 .5-.22.5-.5s-.22-.5-.5-.5-.5.22-.5.5.22.5.5.5zM10 7c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1zm0 5.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm8 .5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0 4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0-8c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0-4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm3 8.5c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zM14 17c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0 3.5c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zm-4-12c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0 8.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm4-4.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0-4c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5z"/></symbol>
</svg>
  </body>
</html>
