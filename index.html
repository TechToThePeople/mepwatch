<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta content="initial-scale=1, shrink-to-fit=no, width=device-width" name="viewport">

    <!-- CSS -->
    <link href="dist/css/main.css" rel="stylesheet">

<style>
.router svg {width:80%;max-height:300px;min-width:300px;fill:#9c27b0}

.router svg:hover { 
  fill:white; 
  animation-name: rubberBand; 
  animation-duration: 1s; 
  animation-fill-mode: both; 
} 

    .icon
    {
      display: inline-block;
      width: 25px;
      height: 20px;
      text-indent: 100%;
      white-space: nowrap;
      overflow: hidden;
      background-size: cover;
      background-position:center;
    }
</style>
  </head>
  <body>
    <header>
      <div class="collapse bg-primary-light" id="navbarHeader">
        <div class="container">
          <div class="row">
            <div class="col-sm-8 col-md-7 py-4">
              <h4 class=""><a href="proposal.html">About</a></h4>
              <p class="">
              </p>
            </div>
            <div class="col-sm-4 offset-md-1 py-4">
              <h4 class="">Contact</h4>
              <ul class="list-unstyled">
                <li><a href="https://twitter.com/eucampaign" class="">Follow on Twitter</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="navbar navbar-dark bg-primary box-shadow">
        <div class="container d-flex justify-content-between">
          <a href="#" class="navbar-brand d-flex align-items-center">
            <svg><use href="#logo" /></svg>MEP Watch
            
          </a>

          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarHeader" aria-controls="navbarHeader" aria-expanded="false" aria-label="Toggle navigation">
            <svg class="icon"><use href="#menu" /></svg>
          </button>
        </div>
      </div>
    </header>

    <main role="main">

      <section class="jumbotron text-center">
        <div class="container">
          <h1 class="jumbotron-heading">Informed citizens = Better democracy</h1>
          <p>
          Score your MEP on the issues you care about: closing the knowledge gap and promoting fact-based CSO campaigning for the European elections.
          </p>
        </div>
      </section>
     <div class="">
        <div class="container">

        <div class="row gradient router">
        <div class="col-md-4 p-4" class="text-center">
          <a href="/presentation" class="text-dark">
            <h3 class="text-center">How this works</h3>
            <div class="text-center">
              <svg viewBox="0 0 200 211"><path d="M30 124h85v5H30zm0-9h113v4H30zm0-10h139v5H30zm0-9h139v4H30zm0-10h139v5H30zm0-10h139v5H30zm0-9h139v5H30zm0-10h139v5H30zm0-9h139v5H30zm0-10h139v5H30zM12 0C5 0 0 5 0 12c0 6 4 10 9 12v127c0 3 2 5 5 5h79v3c-4 2-7 6-7 11l2 6-48 35h24l32-28 4 1 4-1 32 28h23l-9-7-38-28a13 13 0 0 0-5-17v-3h79c3 0 5-2 5-5V24c5-2 9-6 9-12 0-7-5-12-12-12H12zm7 27h162v119H19z"/></svg>
              
<p class="text-center">Our launch at the Eudatathon2018</p></a>
            </div>
      </div>
        <div class="col-md-4 p-4">
          <a href="votes.html" class="text-dark">
            <h3 class="text-center">Analyse votes</h3>
            <svg viewBox="0 0 81 81"><g clip-rule="evenodd" fill-rule="evenodd"><path d="M69 42H56v6h4v1l2 5H16l2-5v-1h4v-6H9 8L1 59l-1 2h78l-9-19zM0 64v17h78v-1-16H0zM81 0H62v17h19V0z"/><path d="M54 26h-1-1l-11 8-2 1c-3 1-5 0-5-2l1-6 1-1H24v26h30z"/><path d="M37 24v-1l2-3 1-2h5v1l-1 1-7 9h-1v3c0 1 1 2 2 1l2-1a4189 4189 0 0 0 15-11l1-3a235 235 0 0 1 3-3V5H49h-1a1288 1288 0 0 0-14 11l-2 4-1 3 1 1h5z"/></g></svg>
<p class="text-center">Get started: pick from all the rollcall votes since 2014</p></a>
      </div>
        <div class="col-md-4 p-4">
            <a href="presentation/app.html" class="text-dark"><h3 class="text-center">Score your MEP</h3>
              <svg viewBox="0 0 67 97"><path d="M42 81l-1-3-1-8h-1l-1-1 3-2 2-1 2 1 1 2v1l-1 1-2 1v3l-1 6c0 1 0 1 0 0z" fill="none"/><path d="M41 29v-2c0-2-1-4-5-5l-3-2 2-4 2-4 2-4h2l4 1 5 4c1 3 0 4-2 9l-6 7h-1zM28 18a42 42 0 0 1-7-4h-1v-1l1-2 2-3 4-6 2-2 6 4c2 1 2 2 2 3l-1 5c-4 6-5 7-8 6zm15 26l-4-2c-1-1-2-2-1-3l1-1v-1a40 40 0 0 1 5-7 201 201 0 0 0 6-9l2-2 3 1 6 5v2l-1 1a39 39 0 0 1-3 6 73 73 0 0 1-10 10h-4zm8 7l-2-2-1-2c0-2 1-2 4-6a283 283 0 0 1 11-11l2 1 2 6-1 4a95 95 0 0 1-13 11l-2-1zM32 41l-4-2v-1l3-2 3-1h4l-1 2a8 8 0 0 0-2 3c-1 2-1 2-3 1z"/><path d="M19 96v-5a51 51 0 0 0 1-6 63 63 0 0 0 1-8v-3c1-4 1-4-2-7L7 50a63 63 0 0 1-7-11l6-11 7-11 1-2h3l3 1a266 266 0 0 0 5 2l7 4 6 3v7l-9 3c-2 0-2-1-5-3l-2-1-3 3c-1 3-1 3 4 5l2 1 8 10a1588 1588 0 0 0 6 8v-2a48 48 0 0 0-4-7 36 36 0 0 0-3-4 3 3 0 0 1-1-1l2-1 9 2 7 6 3 2 1 1 1-1 4-3 5-4 1 4-2 12a25 25 0 0 1-5 8l-2 3-1 13v10l-18 1-17-1zm24-15v-5c0-4 0-4 2-5l2-1-2-3c-2-2-2-2-4 0a53 53 0 0 1-3 3h2l2 8v4l1-1z"/></svg>
          <p>Use the app to score, contact and engage with your MEP</p>
            </a>
      </div>
        </div>
    </main>

    <footer class="text-muted">
      <div class="container">
      </div>
    </footer>

    <!-- Optional JavaScript -->
    <script src="dist/js/main.js"></script> 
    <script src="dist/js/dcbundle.js"></script>
<script>
  'use strict';
  var ndx=null;
  var graphs={};
  var q=d3.queue();
  var docs = {};
  docs.get=function(reference){
    docs[reference] ? docs[reference] : "";
  };

  var dateParse = d3.timeParse("%Y-%m-%d");
  var dateTimeParse = d3.timeParse("%Y-%m-%dT%H:%M:%S");
  var dayFormat = d3.timeFormat("%Y-%m-%d");
  var dateFormat = d3.timeFormat("%Y-%m-%d %H:%M:%S");
  var week = d3.timeFormat("%V");
  //d3.csv('data/ep_votes.csv',function(d){
  q
  .defer(dl_votes)
  .defer(dl_doc)
  .awaitAll(function(error,results){
    draw();
  });

  function dl_doc (callback){
    d3.csv('data/text_tabled.csv',function(d){
      docs[d.reference]=d;
    }).then(function(d){
      callback();
    });
  };

  function dl_votes (callback){
    d3.csv('data/item_rollcall.csv',function(d){
      d.date=dateParse(d.date.substring(0,10));
      if (!d.date) {console.log(d)};
      
      d.day=d.date.getDay();
      d.week=+week(d.date);
      d.year=d.date.getYear();
      ["for","against","abstention","identifier"].forEach(function(i) {
        d[i]= +d[i] || "";
      });
      return d;
    })
    .then(function(d){
      ndx = crossfilter(d);
//      draw();
      callback();
    });
  };

  function draw(){
    graphs.date=drawDate('#date div.graph');
    graphs.report=drawReport('#report div.graph');
    graphs.table=drawTable('table.table');
    graphs.search=drawSearch("form#search");

    dc.renderAll();
  }

  function drawReport(dom){

    var tip = d3.tip()
      .attr('class', 'd3-tip')
      .offset([0, 10])
      .direction("e")
      .html(function(d) {
        console.log(docs[d.key]);
        return docs[d.key]? "<h3>"+docs[d.key].rapporteur+"</h3>"+docs[d.key].title +":"+ d.value: d.value;
//        return abbr(d.key) + "<br><b>" + d.value + " MEPs</b>&nbsp;<i>" + formatPercent(d.value/summary.total) +"</i>";
      });

    //var dim = ndx.dimension(function(d) {return d.report?d.report:"?";}, true);
    var dim = ndx.dimension(function(d) {return d.report? d.report : "?";});
    var group = dim.group().reduceSum(function(d) {
      return 1;
    });

    var graph = dc.rowChart(dom)
      .width(0)
      .height(300)
      //      .rowsCap(18)
//      .ordering(function(d) {  return -d.key      })
      .cap(10)
      .label (function(d){return docs[d.key]? docs[d.key].rapporteur : d.key})
      .renderTitle(false)
      .margins({
        top: 0,
        right: 0,
        bottom: 20,
        left: 0
      })
//      .ordinalColors([committee_color])
      .gap(0)
      .elasticX(true)
      .dimension(dim)
      .group(group)
      .on("renderlet.top", function(c) {
          c.selectAll("g.row")
            .call(tip)
            .on("mouseover.tip", tip.show)
            .on("mouseout.tip", tip.hide);
      });
    graph.xAxis().ticks(3);

    return graph;
  }

  function drawDate(dom){ // not working for now....
    //var dim=ndx.dimension(function(d){return [d.year,d.week,d.day]});
    var col=d3.timeFormat("%y-%m-%w");
    var coltick=d3.timeFormat("%b");
    var lasttick="";
    var dim=ndx.dimension(function(d){return d.date});
    var group=dim.group().reduceSum(function(d){return 1});
    var day=["Sun","Mon","Tue","Wed","Thu","Fri"];
    var color = d3.scaleLinear()
            .domain([0,1, 300])
            .range(["white","lightgrey","#7b2253"]);
    var graph=dc.heatMap(dom)
     .dimension(dim)
     .group(group)
     .width(0)
     .height(150)
      .rowsLabel(function(d){
        return day[d];
      })
      .colsLabel(function(d){
        var t=Math.floor(d /100000);
        if(lasttick !==t){
          lasttick=t;
          return t;
        }
        return "";
     })
     .title(function(d){return dayFormat(d.key)+ " "+d.value+ " rollcalls"})
     .label(function(d){return dayFormat(d.key) + " "+d.value+ " rollcalls"})
     .keyAccessor(function(d) { 
       return 1000*d.key.getFullYear()+week(d.key);
       var r=d.key;
       r.setDate(r.getDate() + d.key.getDay());
       console.log(r);
       return r;
     })
     .valueAccessor(function(d) { return +d.key.getDay(); })
     .colorAccessor(function(d) { return +d.value; })
     .colors(color)
    .on ("renderlet.collabel",function (chart) {
      return;
   // rotate x-axis labels
      chart.selectAll('g.cols text')
      .attr("style","text-anchor:left;")
     //.attr('transform', 'translate(-10,10) rotate(215)');
    });


    return graph;
  }

  function drawSearch(dom){

    var dim=ndx.dimension(function(d) {return d.report.toLowerCase()+" "+ d.desc.toLowerCase() });
    var filter = function (query) {
//        query = _normalize(query);
        return function (d) {
            return d.indexOf(query.toLowerCase()) !== -1;
        };
    };
    var chart=dc.textFilterWidget(dom)
      .placeHolder("search by name")
      .filterFunctionFactory(filter)
      .on("filtered",function(){
        console.log("filter");
      })
      .on("renderlet.urlparam",function(){
        var q=urlParam("q");
        var input=d3.select(this.anchor() +" input");
        if (input.property("value")) {
          if (q != input.property("value")) {
            urlParam("q",input.property("value"));
          }
          return; // nothing else to do, already set
        }
        if (q) {
          console.log("filtering for "+q);
          input.property("value",q).dispatch("input");
        }
      })
      .dimension(dim);
    return chart;
  }

  function drawTable(dom){
    var dim = ndx.dimension(function(d) {
      return d.identifier
    });
    var graph = dc.dataTable(dom)
      .dimension(dim)
      .size(100)
      .sortBy(function(d) {
        return d.date;
      })
      .order (d3.descending)
      .showGroups(false)
      .group(function(d) {
        return null;
      })
      .columns([
        function(d) {
          return "<span title='"+d.identifier+"'>" +dayFormat(d.date) +"</span>";
        }
        ,function(d){ 
          if (docs[d.report])
            return "<div class='rapporteur'>" +docs[d.report].rapporteur +"</div><a href='"+ docs[d.report].doc+"'>"+ d.report +"</a>";
          return d.report;
        }
        ,function(d){ 
          return docs[d.report]? "<a href='"+docs[d.report].oeil+"'>"+docs[d.report].title +"</a>"+d.desc : d.desc;}
        ,function(d){ return d.for;}
        ,function(d){ return d.against;}
        ,function(d){ return d.abstention;}
    ])
    .on("renderlet.govote", function(g) {
      g.selectAll("tr.dc-table-row")
        .on("click", function(d) {
          window.open("vote.html?v="+d3.select(this).datum().identifier);
          console.log(d3.select(this).datum());
        });
    });
    return graph;
  }

var urlParam = function (name,value) {
  if (value) {
    var uri=window.location.href;
    var re = new RegExp("([?&])" + name + "=.*?(&|#|$)", "i");
    if (uri.match(re)) {
    uri=uri.replace(re, '$1' + name + "=" + value + '$2');
    } else {
      var hash =  '';
      if( uri.indexOf('#') !== -1 ){
        hash = uri.replace(/.*#/, '#');
        uri = uri.replace(/#.*/, '');
      }
      var separator = uri.indexOf('?') !== -1 ? "&" : "?";
      uri= uri + separator + name + "=" + value + hash;
    }
    history.pushState({q:value},"search for "+value,uri);
    return uri;
  } else {
    var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
    if (results == null) {
      return null;
    } else {
      return decodeURI(results[1]) || 0;
    }
  }
};


</script>

<svg class="d-none">
  <symbol id="menu" viewBox="0 0 24 24">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
</symbol>
<symbol id="logo" viewBox="0 0 24 24"><path d="M6 13c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0 4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0-8c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm-3 .5c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zM6 5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm15 5.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5-.5.22-.5.5.22.5.5.5zM14 7c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1zm0-3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5-.5.22-.5.5.22.5.5.5zm-11 10c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zm7 7c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zm0-17c.28 0 .5-.22.5-.5s-.22-.5-.5-.5-.5.22-.5.5.22.5.5.5zM10 7c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1zm0 5.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm8 .5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0 4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0-8c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0-4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm3 8.5c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zM14 17c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0 3.5c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zm-4-12c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0 8.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm4-4.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0-4c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5z"/></symbol>
</svg>
  </body>
</html>
